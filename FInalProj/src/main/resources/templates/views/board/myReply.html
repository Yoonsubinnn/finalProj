<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>작성 댓글</title>
    <link rel="stylesheet" href="css/board/myReply_style.css">
    <script src="http://code.jquery.com/jquery-3.6.1.min.js"></script>
    <style>
    	.flex-container {
        	display: flex;
   		}
    </style>
</head>
<body>
	<div th:replace="~{../common/header :: header}"></div>
	<div class="flex-container">
		<div th:replace="~{views/common/sidebar :: sidebar}"></div>
	    <section id="myReplySection">
	        <div>
	            <div id="myReplyTitle">내가 작성한 댓글</div>
	        </div>
	
	        <div class="actionArea">
	            <div class="checkArea">
	                <button class="checkBtn">전체 선택</button>
	                <button class="deleteReplyBtn" onclick="location.href='#'">삭제</button>
	            </div>
	        </div>
			
	        <table class="myReplyTable">
	            <thead>
	                <tr>
	                    <th>✔️</th>
	                    <th>No</th>
	                    <th style="width: 25%">글 제목</th>
	                    <th style="width: 40%;">댓글 내용</th>
	                    <th>작성일</th>
	                </tr>
	            </thead>
	            <tbody>
	                <tr th:each=" r : ${list}">
	                    <td><input type="checkbox" class="checkBoard"></td>
	                    <td id="replyNo">[[${r.replyNo}]]</td>
	                    <td>
	                        <div class="myBoardTitle_wrap">
								<p class="myBoardTitle">[[${r.boardTitle}]]</p>
							</div>
	                    </td>
	                    <td>
	                        <div class="myReply_wrap">
	                            <p class="myReply">[[${r.replyContent}]]</p>
	                        </div>
	                    </td>
	                    <td>[[${r.replyDate}]]</td>
	                </tr>
	                <tr>
		        	<th:block th:if="${#lists.isEmpty(list)}">
			            <td colspan="5" id="emptyReplyList">작성한 댓글이 없습니다.</td>
			        </th:block>
					</tr>
	            </tbody>
	        </table>
	        <div class="page" th:with="loc=${#ctx.springRequestContext.requestUri}">
	            <ul class="pagination">
	                <li th:if="${ pi.currentPage > 1 }">
		                <a class="first" th:href="@{${loc}(page=${ pi.currentPage -1 })}">
		                	<img class="arrowKey" src="image/before.png">
		                </a>
	                </li>
	                <li th:unless="${ pi.currentPage > 1 }">
		                	<img class="arrowKey disabled" src="image/before.png">
	                </li>
	                
	                <li th:each="p : ${ #numbers.sequence(pi.startPage, pi.endPage)}">
	                	<th:block th:if="${p != 0}">
	                	<a th:href="@{${loc}(page=${p})}" th:text="${p}"
	                		th:class="${p == pi.currentPage} ? 'num currentPage' : 'num'"></a>
	                	</th:block>
	                </li>
	                
	                <li th:if="${ pi.currentPage < pi.maxPage} ">
		                <a class="last" th:href="@{${loc}(page=${ pi.currentPage + 1 })}">
		                	<img class="arrowKey" src="image/next.png">
		                </a>
	                </li>
	                <li th:unless="${ pi.currentPage < pi.maxPage }">
		                	<img class="arrowKey disabled" src="image/next.png">
	                </li>
	            </ul>
	        </div>
	    </section>
	</div>
	<br><br>
    <div th:replace="~{views/common/footer :: footer}"></div>
    <script>
    	window.onload = () => {
    		
			const tds = document.querySelector('tbody').querySelectorAll('td');
			
			for(const td of tds){
                td.addEventListener('click', function(){
                    const tr = this.parentElement;
                    const checkBoards = tr.querySelectorAll('.checkBoard');
                    for(const checkBoard of checkBoards){
                        if(checkBoard.checked){
                            checkBoard.checked = false;
                        } else {
                            checkBoard.checked = true;
                        }
                    }
                });
            }
			
// 			for(const td of tds){
// 				td.addEventListener('dblclick', function(){
// 					const tr = this.parentElement;
// 					const replyNo = tr.children[1].innerText;
					
// 					location.href='replyToBoard.bo?' + replyNo;
// 				})
// 			}
			
            const inputs = document.querySelectorAll('.checkBoard');
            
            for(const input of inputs){
                input.addEventListener('click', function(){
                    const td = this.parentElement;
                    const tr = td.parentElement;
                    const checkBoards = tr.querySelectorAll('.checkBoard');
                    for(const checkBoard of checkBoards){
                        if(checkBoard.checked){
                            checkBoard.checked = false;
                        } else {
                            checkBoard.checked = true;
                        }
                    }
                });
            }

            
            let flagCheck = true;

            document.querySelector('.checkBtn').addEventListener('click', function(){
                for(const td of tds){
                    const checkBoards = document.querySelectorAll('.checkBoard');
                    for(const checkBoard of checkBoards){
                        checkBoard.checked = flagCheck;
                    }
                }
                flagCheck = !flagCheck;
            });
            
            
            // 선택한 댓글 삭제
            document.getElementsByClassName('deleteReplyBtn')[0].addEventListener('click', function(){
            	let replies = '';
            	
            	const trs = document.querySelector('tbody').querySelectorAll('tr');
            	
            	for(const tr of trs){
	                const checkBoards = tr.querySelectorAll('.checkBoard');
	                for(const checkBoard of checkBoards){
                        if(checkBoard.checked){
                        	if(replies != ''){
                        		replies += ',';
                        	}
	            			replies += tr.querySelector('#replyNo').innerText;
                        } 
                    }
            	}
            	console.log(replies);
            	
            	$.ajax({
            		url: 'deleteMyReply.bo',
            		data: {replies: replies},
            		success: data =>{
            			console.log(data);
            			alert('선택한 댓글이 삭제되었습니다');
            			location.href = location.pathname + location.search;
//             			현재 URL의 경로(pathname) + 쿼리 문자열(search)만으로 페이지를 다시로드

//             			location.reload(); → 는 페이지 리로드 후 뒤에 해시가 붙음
            		},
            		error: data =>{
            			console.log(data);
            			alert('댓글 삭제에 실패하였습니다.');
            		}
            	});
            });
            
    	}
    </script>
</body>
</html>